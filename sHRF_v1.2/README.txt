********************************************************************************
*********                     sHRF README                              *********
********************************************************************************

INTRODUCTION
sHRF refers to an implementation of supplementary Hemodynamic Response Function modelling based on fMRI by Zuyao Shan and David Reutens. We recommend that you start by reviewing our paper.

Please cite the following paper, which provides a full description of the toolbox, when you publish any work using the toolbox:

Shan ZY, Wright MJ, Thompson PM, McMahon KL, Blokland  GAM, de Zubicaray GI, Martin NG, Vinkhuyzen AE, Reutens DC. Modeling of the Hemodynamic Responses in Block Design fMRI Studies. J of Cerebral Blood Flow & Metabolism. 2013 Nov 20. doi: 10.1038/jcbfm.2013.200. [Epub ahead of print], PMID: 24252847.

This README gives a brief introduction to the installation and use of the sHRF toolbox for SPM. The author assumes the users already familiar with SPM and its terminology.

*******************************************************************************

INSTALLATION
The sHRF tool is a suite of MatLab functions and scripts, which utilise the SPM API (application programming interface) to implement HRF modelling.

sHRF therefore *must* be installed alongside SPM8. The sHRF were developed in context of SPM8, the compatibility with earlier version of SPM (SPM99-SPM5) was not tested.

Installation is relatively straightforward. Download the zip file and uncompress it to a directory named sHRF.

Add the full pathname of this directory to your MATLABPATH, ensuring that the first SPM distribution on the MATLABPATH is SPM8. (You can check this by typing which spm in MatLab and examining the path, or try spm ver). Note that none of the names of sHRF routines clash with those of SPM8 so the positioning of sHRF on the MATLABPATH is not important.

For step by step instructions on downloading and installing SPM distributions, refer to the SPM distribution page:

	http://www.fil.ion.ucl.ac.uk/spm/distrib.html
******************************************************************************

GETTING STARTED
There are two version of sHRF modelling tool. One uses the fMRI data from SPM cluster extraction (sHRF_TC). The other uses the VOI definition images, SPMt map, and the fMRI volumes (sHRF_VOI) to model HRFs. These two sHRF tools are invoked with the command 'sHRF_TC' OR 'sHRF_VOI' at the MatLab prompt. We recommend you start by reviewing our paper.

sHRF_TC requires an fMRI time course generated by SPM (a .mat file). You need to generate an fMRI time course using SPM. In the SPM “Results” window GUI (graphic user interface), you can adjust the cluster / cross-hair position, then click on the "eigenvar" button to extract a .mat file containing the fMRI time response within that cluster. This .mat file is saved at the directory where SPM.mat located and will be used as the input file of the sHRF_TC.

sHRF_VOI takes a volume of interest (VOI) definition image, the group activation SPMt map, the individual activation SPMt map, and the preprocessed fMRI volumes to extract the fMRI signal response from the fMRI volumes directly for an individual subject. NOTE: The authors assume that all input images (VOI definition image, SPMt map, preprocessed fMRI volumes) are in the same coordinate system!

The sHRF requires the fMRI experimental designs so that the HRF can be modelled. The time unit for sHRF is set in seconds. This software does not support designs which have been specified in “scans”. We strongly suggest run the example data first to have sense of the meaning of the parameters. 
******************************************************************************

EXAMPLE DATA
An example dataset is included with this software distribution.  This includes an fMRI time-series (.mat file) extracted via the SPM eigenvar function/button. 

The experimental design is as follows. Participants performed an N-Back working memory task, completing both both 0-back and 2-back conditions.  The 0-back condition requires participant identify to the stimulus (a number) displayed in the present trial.  The 2-back condition requires participants identify the stimulus presented 2 trials ago. Number stimuli were presented for 200 ms with 800 ms gaps. The participant performed each condition (0, or 2-back) for 16 trials, as a single block. In total 16 alternating blocks were performed (8 blocks per condition). The task condition was identified by the background colour of the screen. 

The 127 fMRI volumes (TR = 2.1s, TE = 30 ms, flip angle = 90, 3.6 × 3.6 × 3.0 mm) were acquired continuously during the tasks. The first five volumes were discarded to ensure that tissue magnetization had reached steady state. Therefore, these five volumes were not preprocessed or analysed. The cognitive task started with 0 back block simultaneously with the first processed fMRI volumes.    

The activation cluster is assumed to reflect increased working memory demands, and was generated as a contrast of the 0-back vs 2-back conditions (i.e. contrast vector [-1 1 0]).

sHRF parameters 
For the example dataset, the following sHRF parameters are required:

- The repetition time of image: 2.1s (This refers to the fMRI TR for a whole volume)
- First volume acquisition time: 0 (This refers to the selected/processed fMRI acquisition time)
- Specify fMRI volumes for baseline: 1:7 (This refers to fMRI volume number that has no tasks, in the example data, the first 7 volumes are fMRI with 0 back tasks and treated as baseline here)
- Stimulus function: boxcar function (In the example data, we followed the experimental design exactly. However, one may treat them as stick function too.)
- The length of experiment: 256 (This is the length of whole experiment, specified in seconds. In the example data, we have 16 alternative 0- and 2-back block, each block is 16s. Therefore, the total length is 256s)
- The stimuli onset time in seconds: 16:31 48:63 80:95 112:127 144:159 176:191 208:223 240:255 (This is the exact time for each stimulus on time)
- The number of the stimuli per block: 16
- The stimulus duration in seconds: 0.2 (In example data, The number was presented for 200 ms with 800 ms gaps)

We have not included example data for sHRF_VOI function in this distribution. However, the meaning of the parameters are the same in sHRF_VOI toolkit. Several additional parameters are required for fMRI time response extraction. The VOI image is used to define the location of VOIs, multiple VOIs could be defined in the same image with different integers (NOTE: only integers are accepted here). The VOI image is overlayed on the group activation map to define specific activation clusters within the VOI ( conjunction image). sHRF selects activated voxels according the individual SPMt map within the activation cluster defined in the last step. All fMRI volumes specified in the first level design matrix are required to extract time-series response. The group activation map threshold is the FWE (family wise error) adjusted T score to determine the group activation. Low pass filter is used to removal low pass noise (generally 128s is used). The “Reliable group activation percentage” specifies the amount of the significant individual subject SPMt map which is extracted [within the conjunction of the group activation cluster and the specified VOI]. For an example, 0.2 means sHRF will selected top 20% voxels according to individual SPM T score that are within the activation cluster found by the overlap of the anatomic structures and the group activation.   
*********************************************************************************

OUTPUTS
The sHRF generates a text-file within the specified output directory, containing the estimated HRF, plus modelling performance data of residual sum of squares (RSS) and Akaike information criterion (AIC). As this text-file is generated, two matlab figures are also produced. The figure titled "fMRI signal changes" summarises the fMRI and fitted signal changes. The cyran line reflects the fMRI time series response, grey lines represents the stimulus function and the magenta line is the fitted fMRI response. The figure titled as "Estimated HRF" is a plot of the estimated HRF.

The text-file output generated by running sHRF_VOI includes a summary of the physical or structural features of the VOI’s. The structure ID is the intensity read from the VOI image. Cluster size reflects size in term of the number of voxels. 

The text-file output generated by runngin sHRF_TC includes statistical parameter information. HRF VM lists the five free parameters specifying the 2 Gamma functions, and the baseline adjustment (Please refer our paper for detailed explanation of the parameters). The estimated HRF features such as height, time to peak, width, onsets (time HRF reaches 10% of its maximum height), and area under curve (AUC) are also provided. In addition, RSS and AIC are also provided. 
*********************************************************************************

DISCLAIMER
The sHRF toolkit was developed for research purpose only. sHRF is distributed under the terms of the GNU General Public Licence as published by the Free Software Foundation (either version 2, as given in file spm_LICENCE.man, or at your option, any later version). In particular, sHRF is supplied as is. No formal support or maintenance is provided or implied.
*********************************************************************************

sHRF is developed by Zuyao Shan
		     David Reutens
		     Centre for Advanced Imaging
		     The University of Queensland
		     Brisbane, Australia
*********************************************************************************	     

      
      

